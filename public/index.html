<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zå…ˆæ£®.AI - Pro (V6.8 ç»ˆæUIé‡æ„ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           2. å…¨å±€æ ·å¼å®šä¹‰ (ä¿æŒ V6.6 é€»è¾‘ä¸å˜)
           ========================================= */
        body { 
            background-color: #f8fafc; 
            font-family: 'Inter', system-ui, sans-serif; 
            color: #334155; 
        }
        
        /* --- æŒ‰é’®ç‰¹æ•ˆ (ç»Ÿä¸€äº¤äº’æ„Ÿ) --- */
        .btn-primary { 
            background: linear-gradient(135deg, #DB4437 0%, #C5221F 100%); 
            color: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(219, 68, 55, 0.3); 
        }
        .btn-primary:active { 
            transform: translateY(0); 
        }
        .btn-primary:disabled { 
            background: #cbd5e1; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }

        /* --- æ¬¡è¦/å±é™©æŒ‰é’® (æ–°å¢) --- */
        .btn-ghost-danger {
            background-color: white;
            color: #ef4444;
            border: 1px solid #fee2e2;
            transition: all 0.2s;
        }
        .btn-ghost-danger:hover {
            background-color: #fef2f2;
            border-color: #ef4444;
        }

        /* --- è¾“å…¥æ¡†äº¤äº’ (å¢å¼ºè´¨æ„Ÿ) --- */
        .input-field { 
            transition: all 0.2s; 
            border: 1px solid #e2e8f0; 
            background-color: white; /* æ”¹ä¸ºç™½è‰²èƒŒæ™¯ */
            appearance: none; /* V6.8æ–°å¢: å»é™¤é»˜è®¤ä¸‹æ‹‰ç®­å¤´ */
        }
        .input-field:focus { 
            border-color: #DB4437; 
            background-color: white;
            box-shadow: 0 0 0 4px rgba(219, 68, 55, 0.1); 
            outline: none;
        }

        /* V6.8æ–°å¢: è‡ªå®šä¹‰ Select ç®­å¤´ */
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: "â–¼"; font-size: 10px; color: #94a3b8; 
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%); pointer-events: none;
        }

        /* --- è‡ªå®šä¹‰ Checkbox --- */
        .checkbox-custom {
            appearance: none; 
            background-color: #fff; 
            margin: 0; 
            font: inherit; 
            color: currentColor; 
            width: 1.15em; 
            height: 1.15em; 
            border: 1px solid #cbd5e1; 
            border-radius: 0.25em; 
            display: grid; 
            place-content: center; 
            transition: all 0.2s; 
            cursor: pointer;
        }
        .checkbox-custom::before { 
            content: ""; 
            width: 0.65em; 
            height: 0.65em; 
            transform: scale(0); 
            transition: 120ms transform ease-in-out; 
            box-shadow: inset 1em 1em white; 
            transform-origin: center; 
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); 
        }
        .checkbox-custom:checked { 
            background-color: #DB4437; 
            border-color: #DB4437; 
        }
        .checkbox-custom:checked::before { 
            transform: scale(1); 
        }

        /* --- ç”»å»Šç½‘æ ¼å¸ƒå±€ --- */
        .gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 1rem; 
        }
        
        /* --- æ»šåŠ¨æ¡ç¾åŒ– --- */
        .thin-scrollbar::-webkit-scrollbar { 
            height: 6px; 
            width: 6px; 
        }
        .thin-scrollbar::-webkit-scrollbar-track { 
            background: transparent; 
        }
        .thin-scrollbar::-webkit-scrollbar-thumb { 
            background-color: #cbd5e1; 
            border-radius: 3px; 
        }
        
        /* --- V6.8 é‡æ„: é£æ ¼å¡ç‰‡ (æ”¯æŒèƒŒæ™¯å›¾) --- */
        .style-card { 
            flex: 0 0 120px; 
            height: 70px; /* åŠ å¤§å°ºå¯¸ */
            border-radius: 12px; 
            position: relative; 
            cursor: pointer; 
            border: none; 
            overflow: hidden; 
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-size: cover; 
            background-position: center;
        }
        /* é»‘è‰²åŠé€æ˜é®ç½©ï¼Œä¿è¯æ–‡å­—æ¸…æ™° */
        .style-card::before {
            content: ""; position: absolute; inset: 0; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.2)); 
            z-index: 1; transition: all 0.3s;
        }
        .style-card span { 
            position: relative; 
            z-index: 10; 
            color: white; 
            font-size: 13px; 
            font-weight: 700; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
            width: 100%; 
            height: 100%;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .style-card:hover { transform: translateY(-2px); }
        .style-card:hover::before { background: rgba(0,0,0,0.4); } 
        
        .style-card.active { 
            transform: scale(0.98); 
        }
        .style-card.active::after { 
            content: 'âœ“'; 
            position: absolute; 
            inset: 0; 
            border: 2px solid #DB4437; 
            border-radius: 12px; 
            z-index: 20; 
            color: white; 
            font-size: 10px; 
            font-weight: bold; 
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            padding: 4px 6px; 
            background: transparent;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* --- å‚è€ƒå›¾ç¼©ç•¥å›¾ --- */
        .ref-thumb { 
            flex: 0 0 70px; 
            height: 70px; 
            border-radius: 8px; 
            border: 2px solid transparent; 
            cursor: pointer; 
            overflow: hidden; 
            position: relative; 
            transition: all 0.2s; 
            opacity: 0.6; 
            filter: grayscale(50%); 
        }
        .ref-thumb img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .ref-thumb:hover { 
            opacity: 0.8; 
        }
        .ref-thumb.selected { 
            border-color: #DB4437; 
            ring: 2px solid #fee2e2; 
            transform: scale(0.95); 
            opacity: 1; 
            filter: grayscale(0%); 
        }
        
        .ref-number { 
            position: absolute; 
            top: 2px; 
            left: 2px; 
            background: rgba(0,0,0,0.6); 
            color: white; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            font-size: 9px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            pointer-events: none; 
        }
        .ref-thumb .del-btn { 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            background: rgba(0,0,0,0.5); 
            color: white; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            font-size: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            transition: opacity 0.2s; 
        }
        .ref-thumb:hover .del-btn { 
            opacity: 1; 
        }

        /* --- ä¸Šä¼ åŒºåŸŸ --- */
        .upload-zone { 
            border: 2px dashed #e2e8f0; 
            transition: all 0.2s; 
        }
        .upload-zone:hover { 
            border-color: #DB4437; 
            background: #fff1f2; 
        }
        
        /* --- æ‰¹é‡é€‰æ‹©æ ·å¼ --- */
        .selected-card { 
            outline: 3px solid #DB4437; 
            transform: scale(0.95); 
        }
        .check-circle { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            background: white; 
            border: 2px solid #ddd; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s; 
        }
        .selected-card .check-circle { 
            background: #DB4437; 
            border-color: #DB4437; 
            color: white; 
        }

        /* --- V6.8 é‡æ„: ç”»è´¨ä¸ç§¯åˆ†å¡ç‰‡ --- */
        .quality-card { 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 12px 8px; 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.2s; 
            background: white; 
        }
        .quality-card:hover { 
            border-color: #cbd5e1; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }
        .quality-card.active { 
            border-color: #DB4437; 
            background-color: #fef2f2; 
            color: #b91c1c; 
            ring: 1px solid #DB4437; 
        }
        .quality-name { 
            display: block; 
            font-weight: 800; 
            font-size: 12px; 
            margin-bottom: 2px; 
        }
        .quality-cost { 
            font-size: 10px; 
            color: #64748b; 
        }
        .quality-card.active .quality-cost { 
            color: #b91c1c; 
            font-weight: bold; 
        }
        
        /* --- ç§¯åˆ†å¾½ç«  --- */
        .credit-badge { 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); 
            color: #ffd700; 
            padding: 6px 16px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* --- åŠ è½½æ›´å¤šæŒ‰é’®æ ·å¼ --- */
        .btn-load-more {
            display: block; 
            margin: 2rem auto; 
            padding: 10px 30px; 
            border: 1px solid #e2e8f0; 
            background: white; 
            color: #64748b; 
            border-radius: 50px; 
            font-weight: 600; 
            font-size: 14px; 
            transition: all 0.2s; 
            cursor: pointer;
        }
        .btn-load-more:hover { 
            border-color: #DB4437; 
            color: #DB4437; 
        }
        .btn-load-more:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
    </style>
</head>
<body class="h-screen overflow-hidden text-slate-700 bg-slate-50">

    <div id="lightbox" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col items-center justify-center p-4">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 text-white/50 hover:text-white text-4xl">&times;</button>
        <img id="lightbox-img" class="max-w-full max-h-[85vh] rounded shadow-2xl object-contain">
        <div class="flex gap-4 mt-6">
            <button id="lightbox-download" class="px-6 py-2 bg-white text-black rounded-full font-bold text-sm hover:bg-gray-200 transition cursor-pointer">ä¸‹è½½åŸå›¾</button>
            <button id="lightbox-del-btn" class="px-6 py-2 bg-red-600/20 text-red-500 border border-red-600/50 rounded-full font-bold text-sm hover:bg-red-600 hover:text-white transition">åˆ é™¤</button>
        </div>
    </div>

    <div id="batch-bar" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 bg-white shadow-2xl border border-gray-200 rounded-full px-6 py-3 flex items-center gap-6 hidden transform transition-all duration-300 translate-y-20">
        <div class="text-sm font-bold text-gray-700">å·²é€‰ <span id="select-count" class="text-red-600">0</span> å¼ </div>
        <div class="h-4 w-[1px] bg-gray-300"></div>
        <button onclick="deleteBatch()" class="text-red-500 font-bold text-sm hover:text-red-700 flex items-center gap-1"><span>ğŸ—‘ï¸</span> æ‰¹é‡åˆ é™¤</button>
        <button onclick="toggleSelectMode()" class="text-gray-400 text-sm hover:text-gray-600 ml-2">å–æ¶ˆ</button>
    </div>

    <div id="auth-view" class="fixed inset-0 z-50 flex h-screen w-full bg-white">
        <div class="hidden lg:flex w-1/2 bg-slate-900 relative overflow-hidden items-end">
            <img src="https://images.unsplash.com/photo-1486325212027-8081e485255e?q=80&w=2070&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60">
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
            <div class="relative z-10 p-16 text-white max-w-xl">
                <h2 class="text-5xl font-black mb-6 leading-tight tracking-tight">Design with<br>Nano Banana Pro.</h2>
                <p class="text-lg text-slate-300 font-light leading-relaxed">Google æœ€å¼ºå»ºç­‘çµæ„Ÿå¼•æ“ã€‚<br>ä¸“ä¸ºå»ºç­‘å¸ˆæ‰“é€ çš„é«˜çº§å·¥ä½œå°ã€‚</p>
            </div>
        </div>
        
        <div class="w-full lg:w-1/2 flex flex-col justify-center items-center p-8 bg-white relative">
            
            <div id="card-login" class="w-full max-w-md animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic">Zå…ˆæ£®.AI</h1>
                    <p class="text-slate-400 text-sm mt-1">v6.8 Enterprise (Pro)</p>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email</label>
                        <input type="email" id="email" class="input-field w-full px-5 py-4 rounded-xl text-slate-800 outline-none" placeholder="name@studio.com">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Password</label>
                        <input type="password" id="password" class="input-field w-full px-5 py-4 rounded-xl text-slate-800 outline-none" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="remember-me" class="checkbox-custom" checked><span class="text-sm text-slate-500 font-medium select-none">è®°ä½æˆ‘</span></label>
                        <button onclick="forgotPassword()" class="text-sm font-bold text-red-600 hover:text-red-700 hover:underline">å¿˜è®°å¯†ç ?</button>
                    </div>
                    <button onclick="signIn()" class="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-lg mt-2">è¿›å…¥å·¥ä½œå°</button>
                    
                    <div class="flex items-center justify-center mt-6 gap-2">
                        <span class="text-xs text-slate-400">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                        <button onclick="switchAuth('register')" class="text-sm font-bold text-red-600 hover:underline">å»æ³¨å†Œ (é€20ç§¯åˆ†)</button>
                    </div>
                </div>
            </div>

            <div id="card-register" class="w-full max-w-md hidden animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic">åˆ›å»ºè´¦å·</h1>
                    <p class="text-slate-400 text-sm mt-1">Join the future of design.</p>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">æ³¨å†Œé‚®ç®±</label>
                        <input type="email" id="reg-email" class="input-field w-full px-5 py-4 rounded-xl text-slate-800 outline-none" placeholder="ä½ çš„å¸¸ç”¨é‚®ç®±">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">è®¾ç½®å¯†ç </label>
                        <input type="password" id="reg-password" class="input-field w-full px-5 py-4 rounded-xl text-slate-800 outline-none" placeholder="è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ">
                    </div>
                    <button onclick="signUp()" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold text-lg shadow-lg mt-2 transition-all">
                        ç¡®è®¤æ³¨å†Œ
                    </button>
                    
                    <div class="flex items-center justify-center mt-6 gap-2">
                        <span class="text-xs text-slate-400">å·²æœ‰è´¦å·ï¼Ÿ</span>
                        <button onclick="switchAuth('login')" class="text-sm font-bold text-red-600 hover:underline">ç›´æ¥ç™»å½•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app-view" class="h-screen flex hidden">
        <aside class="w-20 lg:w-64 bg-white border-r border-gray-200 flex flex-col justify-between z-20">
            <div class="flex-1">
                <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-gray-100"><span class="font-black text-xl text-red-600 italic">Zå…ˆæ£®</span></div>
                <nav class="py-4 space-y-1">
                    <button onclick="switchTab('create')" id="tab-create" class="w-full px-6 py-3 text-left hover:bg-red-50 text-red-600 bg-red-50 border-r-2 border-red-600">ğŸ¨ <span class="hidden lg:inline ml-2 font-bold">åˆ›ä½œ</span></button>
                    <button onclick="switchTab('gallery')" id="tab-gallery" class="w-full px-6 py-3 text-left hover:bg-gray-50 text-gray-500">ğŸ“‚ <span class="hidden lg:inline ml-2 font-bold">æˆ‘çš„ç”»å»Š</span></button>
                    <button onclick="switchTab('profile')" id="tab-profile" class="w-full px-6 py-3 text-left hover:bg-gray-50 text-gray-500">ğŸ‘¤ <span class="hidden lg:inline ml-2 font-bold">ä¸ªäººä¸­å¿ƒ</span></button>
                </nav>
            </div>
            <div class="p-4 border-t"><button onclick="signOut()" class="text-xs text-slate-400 hover:text-slate-600">é€€å‡ºç™»å½•</button></div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-slate-50">
            <header id="main-header" class="h-14 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-20">
                <h1 class="text-sm font-bold text-gray-700">Banana Pro åˆ›ä½œä¸­å¿ƒ</h1>
                <div class="flex items-center gap-4">
                   <div class="credit-badge">
                       <span>ğŸ’</span> <span id="credit-display">--</span>
                   </div>
                   <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded font-mono">V6.8</span>
                </div>
            </header>
            
            <div id="view-create" class="flex-1 flex flex-col lg:flex-row h-full overflow-hidden">
                <div class="w-full lg:w-[420px] bg-white border-r border-gray-200 flex flex-col z-10 shadow-lg">
                    <div class="flex-1 overflow-y-auto p-6 space-y-8 thin-scrollbar"> <div>
                            <label class="font-bold text-sm text-slate-800 flex justify-between mb-3 items-center">
                                <span>é£æ ¼æ»¤é•œ</span>
                                <span id="style-name" class="text-xs text-red-600 font-bold bg-red-50 px-2 py-1 rounded">é»˜è®¤</span>
                            </label>
                            <div class="flex gap-3 overflow-x-auto thin-scrollbar pb-3 -mx-1 px-1" id="style-container"></div>
                        </div>

                        <div>
                            <label class="font-bold text-sm text-slate-800 mb-2 block">è®¾è®¡æŒ‡ä»¤ (Prompt)</label>
                            <textarea id="prompt" rows="3" class="input-field w-full p-4 rounded-xl text-sm leading-relaxed" placeholder="æè¿°ä½ çš„å»ºç­‘çµæ„Ÿï¼šä¾‹å¦‚ä¸€ä¸ªæ‚¬å´–ä¸Šçš„ç°ä»£ç¾æœ¯é¦†ï¼Œé»„æ˜æ—¶åˆ»ï¼Œç»ç’ƒå¹•å¢™åå°„ç€è½æ—¥ä½™æ™–..."></textarea>
                        </div>
                        
                        <div id="upload-section">
                            <label class="font-bold text-sm text-slate-800 flex justify-between mb-2">
                                <span>å‚è€ƒå›¾ <span class="font-normal text-xs text-gray-400 ml-1">æ§åˆ¶æ„å›¾ä¸é£æ ¼</span></span>
                                <span class="text-xs text-red-600 font-mono" id="ref-count">0/10</span>
                            </label>
                            <div id="ref-tray" class="mb-3 flex gap-2 overflow-x-auto thin-scrollbar pb-2 hidden"></div>
                            <div class="relative group">
                                <input type="file" id="refImageInput" accept="image/*" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleImageUpload(this)">
                                <div id="upload-placeholder" class="upload-zone rounded-xl h-24 flex flex-col items-center justify-center text-gray-400">
                                    <span class="text-2xl mb-1">ğŸ“·</span>
                                    <span class="text-xs font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="font-bold text-sm text-slate-800 mb-2 block">ç”»å¹…æ¯”ä¾‹</label>
                            <div class="select-wrapper">
                                <select id="aspect" class="input-field w-full p-3 rounded-xl text-sm font-medium text-slate-700 cursor-pointer">
                                    <option value="original">ğŸ“ æŒ‰åŸå›¾æ¯”ä¾‹ (Auto)</option>
                                    <option value="1:1">1:1 æ­£æ–¹å½¢ (ç¤¾äº¤åª’ä½“)</option>
                                    <option value="16:9">16:9 æ¨ªå± (ç”µå½±æ„Ÿ/å±•ç¤º)</option>
                                    <option value="3:4">3:4 ç«–å± (æµ·æŠ¥/æ‰‹æœº)</option>
                                </select>
                            </div>
                        </div>
                            
                        <div>
                             <label class="font-bold text-sm text-slate-800 mb-2 block flex justify-between">
                                 <span>ç”»è´¨ç­‰çº§</span>
                                 <span class="text-xs text-slate-400 font-normal">æ¶ˆè€—ç§¯åˆ†ä¸åŒ</span>
                             </label>
                             <div class="grid grid-cols-3 gap-3">
                                <div class="quality-card active" onclick="selectQuality('1k', 5, this)">
                                    <span class="quality-name">æ ‡å‡† (1k)</span>
                                    <span class="quality-cost">5 ğŸ’</span>
                                </div>
                                <div class="quality-card" onclick="selectQuality('2k', 10, this)">
                                    <span class="quality-name">é«˜æ¸… (2k)</span>
                                    <span class="quality-cost">10 ğŸ’</span>
                                </div>
                                <div class="quality-card" onclick="selectQuality('4k', 15, this)">
                                    <span class="quality-name">è¶…æ¸… (4k)</span>
                                    <span class="quality-cost">15 ğŸ’</span>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <div class="p-6 border-t bg-white z-20">
                        <button onclick="generate()" id="btn-gen" class="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-lg">
                            ğŸš€ ç«‹å³ç”Ÿæˆ (æ¶ˆè€— 5 ç§¯åˆ†)
                        </button>
                    </div>
                </div>
                <div class="flex-1 bg-gray-100 flex items-center justify-center p-4 relative"><div id="preview" class="bg-white rounded-lg shadow-sm p-2 max-w-full max-h-full overflow-auto flex items-center justify-center min-w-[300px] min-h-[300px]"><span class="text-gray-400">ç­‰å¾…ç”Ÿæˆ...</span></div></div>
            </div>

            <div id="view-gallery" class="hidden flex-1 overflow-y-auto p-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4"><h2 class="text-2xl font-bold">æˆ‘çš„äº‘ç«¯ç”»å»Š</h2><button onclick="toggleSelectMode()" id="btn-batch-toggle" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-bold transition">âš¡ æ‰¹é‡ç®¡ç†</button></div>
                    <button onclick="loadGallery()" class="text-sm text-red-600 hover:underline">åˆ·æ–°</button>
                </div>
                <div id="gallery-grid" class="gallery-grid"></div>
                <button id="btn-load-more" onclick="loadMoreImages()" class="btn-load-more hidden">vv åŠ è½½æ›´å¤šå›¾ç‰‡ vv</button>
            </div>

            <div id="view-profile" class="hidden flex-1 overflow-y-auto p-8 bg-slate-50">
                <div class="max-w-2xl mx-auto space-y-6">
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight mb-8">ä¸ªäººä¸­å¿ƒ</h2>
                    
                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 flex items-center gap-6">
                        <div class="w-20 h-20 bg-gradient-to-br from-red-50 to-red-100 rounded-full flex items-center justify-center text-3xl shadow-inner border border-red-100">
                            ğŸ‘¤
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-0.5 rounded bg-slate-100 text-[10px] font-bold text-slate-500 uppercase tracking-wider">PRO Account</span>
                            </div>
                            <div id="profile-email" class="text-2xl font-bold text-slate-900 tracking-tight mb-1">user@email.com</div>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="text-slate-400 font-mono text-xs">ID: <span id="profile-id">...</span></span>
                                <div class="flex items-center gap-1 text-red-600 font-bold bg-red-50 px-2 py-0.5 rounded-md">
                                    <span>ğŸ’</span> <span id="profile-credits-text">--</span> ç§¯åˆ†
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold mb-6 flex items-center gap-2 text-slate-800">
                            <span class="w-1 h-6 bg-red-600 rounded-full block"></span>ğŸ” å®‰å…¨è®¾ç½®
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 mb-2 block uppercase tracking-wide">ä¿®æ”¹å¯†ç </label>
                                <input type="password" id="new-password" class="input-field w-full p-4 rounded-xl text-sm" placeholder="è¾“å…¥æ–°å¯†ç  (è‡³å°‘6ä½)">
                            </div>
                            <button onclick="updatePassword()" class="w-full btn-primary py-3 rounded-xl font-bold shadow-md">
                                ğŸ”’ æ›´æ–°å¯†ç 
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100">
                        <div class="mb-6">
                            <h3 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                                <span class="w-1 h-6 bg-red-600 rounded-full block"></span>ğŸ“ æ„è§åé¦ˆ
                            </h3>
                            <p class="text-sm text-slate-400 mt-1 pl-3">å¸®åŠ©æˆ‘ä»¬åšå¾—æ›´å¥½ï¼é‡åˆ°çš„ Bug æˆ–åŠŸèƒ½å»ºè®®éƒ½å¯ä»¥å†™åœ¨è¿™é‡Œã€‚</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <textarea id="feedback-content" rows="4" class="input-field w-full p-4 rounded-xl text-sm resize-none" placeholder="è¯·è¯¦ç»†æè¿°ä½ çš„å»ºè®®ï¼Œæˆ–è€…æ˜¯é‡åˆ°çš„ Bug..."></textarea>
                            </div>
                            <div>
                                <input type="text" id="feedback-contact" class="input-field w-full p-4 rounded-xl text-sm" placeholder="è”ç³»æ–¹å¼ (å¾®ä¿¡/Emailï¼Œé€‰å¡«)">
                            </div>
                            <button id="btn-submit-feedback" onclick="submitFeedback()" class="w-full btn-primary py-3 rounded-xl font-bold shadow-md">
                                ğŸš€ æäº¤åé¦ˆ
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-gray-100 flex items-center justify-between">
                         <div>
                            <h3 class="text-lg font-bold text-slate-800 mb-1">ğŸ› ï¸ ç³»ç»Ÿå·¥å…·</h3>
                            <p class="text-xs text-slate-400">æ¸…é™¤æœ¬åœ°ç¼“å­˜ (API Keys/Settings) å¦‚é‡æ•…éšœå¯å°è¯•</p>
                         </div>
                         <button onclick="clearKeys()" class="btn-ghost-danger px-4 py-2 rounded-lg text-sm font-bold">
                            ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜
                         </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- 6.1 å…¨å±€é…ç½®ä¸çŠ¶æ€ ---
        const SERVER_CONFIG = {
            MODELS: {
                '1k': 'gemini-3-pro-image-preview',
                '2k': 'gemini-3-pro-image-preview-2k-vip',
                '4k': 'gemini-3-pro-image-preview-4k-vip'
            }
        };

        const SUPABASE_URL = 'https://sfkaeideyamxcidhsbih.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_KW1ss5pJQgl5iBHBAFvfYg_18EjeXGg'; 

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let refImages = []; 
        let selectedRefIds = new Set();
        let isSelectMode = false; 
        let selectedIds = new Set();
        let currentLightboxId = null; 
        let currentLightboxUrl = null; 
        let currentLightboxPath = null;
        let currentStylePrompt = ""; 
        let abortController = null; 

        // ç§¯åˆ†ç³»ç»Ÿå˜é‡
        let currentCredits = 0;
        let selectedQuality = '1k'; 
        let currentCost = 5;        

        // åˆ†é¡µç³»ç»Ÿå˜é‡
        let currentPage = 0; 
        const PAGE_SIZE = 20; 
        let hasMoreImages = true;

       // --- V6.8 æœ€ç»ˆç‰ˆé…ç½®ï¼šä½¿ç”¨æœ¬åœ° assets è·¯å¾„ ---
        const styles = [
            {
                name: "é»˜è®¤",
                img: "assets/PixPin_2026-01-11_18-47-57.jpg",
                prompt: ""
            },
            {
                name: "å»ºç­‘ç™½æ¨¡",
                img: "assets/80082030d5fda554b772704dc3bdb4b9.jpg",
                prompt: "architectural model rendering, white clay material, monochrome, miniature scale, clean lines, abstract form, studio lighting, soft shadows, untextured, minimalist aesthetic"
            },
            {
                name: "ç®€çº¦ç°ä»£",
                img: "assets/e11796b490c9e9ff20961a0738e5e010.jpg",
                prompt: "minimalist architecture, white concrete, clean lines, bauhaus style, bright natural lighting, photorealistic, 8k"
            },
            {
                name: "å¤œæ™¯",
                img: "assets/7de3bb7cff3f320483eca75de59c3145.jpg",
                prompt: "night scene architecture, building illuminated from within, glowing windows, street lights, dramatic artificial lighting, blue hour sky, deep shadows, cinematic atmosphere, photorealistic"
            },
            {
                name: "èµ›åšæœ‹å…‹",
                img: "assets/c9ac6cf53e2b60718df293aaa5ca0edd.jpg",
                prompt: "cyberpunk architecture, neon lights, futuristic city, night, rain, high tech, blade runner style, volumetric lighting"
            },
            {
                name: "æ–°ä¸­å¼",
                img: "assets/e567b8b5ce1c63887d9a6f3c72369308.jpg",
                prompt: "modern chinese architecture, wooden structure, traditional roof details, zen garden, misty atmosphere, ink painting style aesthetic"
            },
            {
                name: "æ‰å“ˆæµä½“",
                img: "assets/5c5c26205f1cccb8788b6b78ad85feba.jpg",
                prompt: "parametric architecture, zaha hadid style, fluid curves, futuristic facade, steel and glass, organic shape, cinematic lighting"
            },
            {
                name: "å·¥ä¸šé£",
                img: "assets/1285cce92fcdcbcc1dac485bf7b93077.jpg",
                prompt: "industrial loft style, exposed brick, raw concrete, steel beams, large windows, brutalist architecture, dramatic shadows"
            },
            {
                name: "æ£®ä¹‹å±‹",
                img: "assets/2241af18711c385f0691c3cf9ec9840e.jpg",
                prompt: "biophilic architecture, vertical forest, covered in plants, sustainable design, wood and glass, sunlight filtering through leaves"
            }
        ];
        
        // --- 6.2 åˆå§‹åŒ–ä¸ç›‘å¬ ---
        window.onload = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                enterApp(session.user);
                fetchCredits();
            }
            db.auth.onAuthStateChange((_, session) => {
                if(session) {
                    enterApp(session.user);
                    fetchCredits();
                } else {
                    leaveApp();
                }
            });
            renderStyles();
        };

        // --- 6.3 ç§¯åˆ†é€»è¾‘ (åç«¯åŒæ­¥) ---
        async function fetchCredits() {
            const { data: { user } } = await db.auth.getUser();
            if (!user) return;
            const { data } = await db.from('profiles').select('credits').eq('id', user.id).single();
            if (data) {
                currentCredits = data.credits;
                updateCreditUI();
            }
        }

        function updateCreditUI() {
            document.getElementById('credit-display').innerText = currentCredits;
            document.getElementById('profile-credits-text').innerText = currentCredits;
            const btn = document.getElementById('btn-gen');
            if (!abortController) {
                btn.innerText = `ğŸš€ ç«‹å³ç”Ÿæˆ (æ¶ˆè€— ${currentCost} ç§¯åˆ†)`;
            }
        }

        function selectQuality(quality, cost, el) {
            selectedQuality = quality;
            currentCost = cost;
            document.querySelectorAll('.quality-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            updateCreditUI();
        }

        // --- 6.4 èº«ä»½éªŒè¯ä¸è§†å›¾åˆ‡æ¢ (ğŸŸ¢ ä¿®æ­£ç‰ˆ) ---
        
        // åˆ‡æ¢ç™»å½•/æ³¨å†Œè§†å›¾
        function switchAuth(mode) {
            const loginCard = document.getElementById('card-login');
            const registerCard = document.getElementById('card-register');

            if (mode === 'register') {
                loginCard.classList.add('hidden');
                registerCard.classList.remove('hidden');
            } else {
                registerCard.classList.add('hidden');
                loginCard.classList.remove('hidden');
            }
        }

        async function signUp() { 
            // æ³¨æ„ï¼šä½¿ç”¨ä¸“ç”¨çš„æ³¨å†Œè¾“å…¥æ¡†
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value.trim();
            
            if (!email || !password) return alert("è¯·è¾“å…¥æ³¨å†Œé‚®ç®±å’Œå¯†ç ");

            try {
                // å…ˆæ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
                const { data: exists, error: checkError } = await db.rpc('check_email_exists', { 
                    email_input: email 
                });

                if (checkError) throw checkError;

                if (exists) {
                    alert("âŒ è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•ï¼");
                    switchAuth('login');
                    return;
                }

                const { error } = await db.auth.signUp({ email, password });
                
                if (error) {
                    alert("æ³¨å†Œå¤±è´¥: " + error.message);
                } else {
                    alert("âœ… æ³¨å†Œè¯·æ±‚å·²å‘é€ï¼\nè¯·æŸ¥æ”¶é‚®ä»¶ï¼Œç„¶åç™»å½•ã€‚");
                    switchAuth('login');
                    // è‡ªåŠ¨å¡«å…¥é‚®ç®±
                    document.getElementById('email').value = email;
                    document.getElementById('password').value = ''; 
                }

            } catch (err) {
                console.error("Error:", err);
                alert("ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
            }
        }

        async function signIn() { const email=document.getElementById('email').value, password=document.getElementById('password').value; const {error}=await db.auth.signInWithPassword({email,password}); if(error) alert(error.message); }
        async function forgotPassword() { const email=document.getElementById('email').value; if(!email) return alert("è¯·å…ˆè¾“å…¥é‚®ç®±"); const {error}=await db.auth.resetPasswordForEmail(email,{redirectTo:window.location.href}); if(error) alert(error.message); else alert("é‡ç½®é‚®ä»¶å·²å‘é€"); }
        async function signOut() { await db.auth.signOut(); }
        
        function enterApp(user) { 
            document.getElementById('auth-view').classList.add('hidden'); 
            document.getElementById('app-view').classList.remove('hidden'); 
            document.getElementById('profile-email').innerText = user.email;
            document.getElementById('profile-id').innerText = user.id; 
            loadGallery(); 
        }
        function leaveApp() { document.getElementById('auth-view').classList.remove('hidden'); document.getElementById('app-view').classList.add('hidden'); }

        async function updatePassword() { 
            const newPw = document.getElementById('new-password').value; 
            if(!newPw || newPw.length < 6) return alert("å¯†ç å¤ªçŸ­"); 
            const { error } = await db.auth.updateUser({ password: newPw }); 
            if(error) alert("æ›´æ–°å¤±è´¥: " + error.message); 
            else { alert("å¯†ç å·²æ›´æ–°"); document.getElementById('new-password').value = ""; } 
        }

        function clearKeys() { 
            localStorage.removeItem('user_credits'); 
            alert("æœ¬åœ°ç¼“å­˜å·²æ¸…é™¤ï¼Œåˆ·æ–°é¡µé¢å°†ä»äº‘ç«¯é‡æ–°åŒæ­¥æ•°æ®ã€‚"); 
            location.reload();
        }

        // --- 6.5 UI æ¸²æŸ“é€»è¾‘ ---
        function renderStyles() { 
            document.getElementById('style-container').innerHTML = styles.map((s, index) => `
                <div class="style-card ${index === 0 ? 'active' : ''}" 
                     style="background-image: url('${s.img}')" 
                     onclick="selectStyle(this, ${index})">
                     <span>${s.name}</span>
                </div>
            `).join(''); 
        }
        function selectStyle(el, index) { 
            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('active')); 
            el.classList.add('active'); 
            const s = styles[index]; currentStylePrompt = s.prompt; 
            document.getElementById('style-name').innerText = s.name; 
        }
        
        // --- 6.6 ä¸Šä¼ ä¸å«å›¾ç®¡ç† ---
        function handleImageUpload(input) { 
            const files = Array.from(input.files); 
            if (!files.length) return; 
            if (refImages.length + files.length > 10) return alert("æœ€å¤š10å¼ å‚è€ƒå›¾ï¼"); 
            files.forEach(file => { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const id = Date.now() + Math.random(); 
                    refImages.push({ id: id, base64: e.target.result }); 
                    selectedRefIds.add(id); 
                    renderRefTray(); 
                }; 
                reader.readAsDataURL(file); 
            }); 
            input.value = ''; 
        }
        
        function renderRefTray() { 
            const tray = document.getElementById('ref-tray'); 
            const countLabel = document.getElementById('ref-count'); 
            const placeholder = document.getElementById('upload-placeholder'); 
            countLabel.innerText = `${refImages.length}/10`; 
            if (refImages.length > 0) { 
                tray.classList.remove('hidden'); placeholder.classList.add('h-12'); placeholder.innerHTML = '<span class="text-sm font-bold text-red-500">+ ç»§ç»­æ·»åŠ </span>'; 
            } else { 
                tray.classList.add('hidden'); placeholder.classList.remove('h-12'); placeholder.innerHTML = '<span class="text-2xl mb-1">ğŸ“·</span><span class="text-xs font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</span>'; 
            } 
            tray.innerHTML = refImages.map((img, index) => `
                <div class="ref-thumb ${selectedRefIds.has(img.id) ? 'selected' : ''}" onclick="toggleRef(${img.id})">
                    <img src="${img.base64}"><div class="ref-number">${index + 1}</div><div class="del-btn" onclick="event.stopPropagation(); removeRef(${img.id})">âœ•</div>
                </div>`).join(''); 
        }
        function toggleRef(id) { if (selectedRefIds.has(id)) selectedRefIds.delete(id); else selectedRefIds.add(id); renderRefTray(); }
        function removeRef(id) { refImages = refImages.filter(img => img.id !== id); selectedRefIds.delete(id); renderRefTray(); }

        // --- 6.7 åˆ†é¡µç”»å»ŠåŠ è½½ ---
        async function loadGallery(reset = true) { 
            const { data: { user } } = await db.auth.getUser();
            if (!user) return; 
            
            if (reset) {
                currentPage = 0;
                document.getElementById('gallery-grid').innerHTML = '';
                hasMoreImages = true;
            }

            const from = currentPage * PAGE_SIZE;
            const to = from + PAGE_SIZE - 1;
            const btnMore = document.getElementById('btn-load-more');
            
            btnMore.innerText = "åŠ è½½ä¸­...";
            
            const { data, error } = await db
                .from('images')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .range(from, to); 
            
            if (data && data.length > 0) { 
                renderGalleryGrid(data, !reset); 
                if (data.length < PAGE_SIZE) hasMoreImages = false;
            } else {
                hasMoreImages = false;
            }

            if (hasMoreImages) {
                btnMore.classList.remove('hidden');
                btnMore.innerText = "vv åŠ è½½æ›´å¤šå›¾ç‰‡ vv";
                btnMore.disabled = false;
            } else {
                btnMore.classList.add('hidden');
            }
        }

        function loadMoreImages() {
            currentPage++;
            loadGallery(false);
        }

        function renderGalleryGrid(data, append = false) { 
            const html = data.map(img => `
                <div id="card-${img.id}" class="bg-white rounded overflow-hidden shadow group relative border border-gray-100 cursor-pointer transition-all" onclick="handleCardClick('${img.id}', '${img.image_url}', '${img.file_path||''}')">
                    <div class="aspect-square relative">
                        <img src="${img.image_url}" class="w-full h-full object-cover">
                        <div class="normal-overlay absolute inset-0 bg-black/0 group-hover:bg-black/20 transition flex items-center justify-center opacity-0 group-hover:opacity-100 ${isSelectMode ? 'hidden' : ''}">
                            <span class="text-white bg-black/50 px-3 py-1 rounded-full text-xs">ğŸ‘€ æŸ¥çœ‹</span>
                        </div>
                        <div class="batch-overlay check-circle ${isSelectMode ? '' : 'hidden'}"></div>
                    </div>
                    <div class="p-2 flex justify-between items-center bg-gray-50">
                        <span class="text-[10px] text-gray-500 truncate w-20">${img.prompt}</span>
                        <div class="flex gap-2">
                            <span class="text-[9px] uppercase font-bold text-red-500">Pro</span>
                            <button onclick="event.stopPropagation(); deleteSingle(${img.id}, '${img.file_path||''}', '${img.image_url}')" class="text-gray-400 hover:text-red-500 ${isSelectMode ? 'hidden' : ''}" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>`).join('');
            
            const grid = document.getElementById('gallery-grid');
            if (append) grid.insertAdjacentHTML('beforeend', html);
            else grid.innerHTML = html;
        }

        // =======================================================
        // ğŸš€ V6.3 æ ¸å¿ƒç”Ÿæˆé€»è¾‘ (ğŸŸ¢ ä¿®æ­£ï¼šå¢åŠ ä¸‹è½½æŒ‰é’®æ˜¾ç¤º)
        // =======================================================
        async function generate() {
            const btn = document.getElementById('btn-gen');
            const preview = document.getElementById('preview');
            
            if (currentCredits < currentCost) return alert(`ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ ${currentCost} åˆ†ï¼Œå½“å‰ ${currentCredits} åˆ†ã€‚`);

            abortController = new AbortController();
            const signal = abortController.signal;

            btn.innerText = "ğŸ›‘ åœæ­¢ç”Ÿæˆ (åç«¯å¤„ç†ä¸­)";
            btn.classList.replace('btn-primary', 'bg-gray-400');
            btn.onclick = () => abortController.abort(); 

            const { data: { session } } = await db.auth.getSession();
            if (!session) return alert("è¯·é‡æ–°ç™»å½•");
            const token = session.access_token; 
            const userId = session.user.id; 

            let userPrompt = document.getElementById('prompt').value; 
            const aspectStr = document.getElementById('aspect').value; 
            const painterModelId = SERVER_CONFIG.MODELS[selectedQuality];
            const selectedImages = refImages.filter(img => selectedRefIds.has(img.id));
            let tempUploadPaths = []; 

            try {
                let finalPrompt = userPrompt; 
                let refImageUrls = []; 
                let sizeParam = "1024x1024"; 

                // --- æ­¥éª¤ 1: ä¸Šä¼ å‚è€ƒå›¾ ---
                if (selectedImages.length > 0) {
                    preview.innerHTML = `<span class="animate-pulse text-blue-600">æ­£åœ¨ä¸Šä¼  ${selectedImages.length} å¼ å‚è€ƒå›¾...</span>`;
                    
                    if (aspectStr === "original") {
                        try {
                            const img = new Image(); img.src = selectedImages[0].base64;
                            await new Promise(r => img.onload = r);
                            const ratio = img.width / img.height;
                            if (ratio > 1.2) sizeParam = "1792x1024"; 
                            else if (ratio < 0.8) sizeParam = "1024x1792";
                            else sizeParam = "1024x1024";
                        } catch(e) { sizeParam = "1024x1024"; }
                    } else {
                        if (aspectStr === "16:9") sizeParam = "1792x1024";
                        else if (aspectStr === "3:4") sizeParam = "1024x1792";
                    }

                    await Promise.all(selectedImages.map(async (img, index) => {
                        try {
                            const blob = base64ToBlob(img.base64, 'image/png');
                            const tempName = `temp/${userId}/${Date.now()}_${index}.png`;
                            
                            const { error: uploadError } = await db.storage.from('ai-images').upload(tempName, blob);
                            if (uploadError) throw new Error(`Supabase Upload: ${uploadError.message}`);
                            
                            tempUploadPaths.push(tempName); 
                            const { data: { publicUrl } } = db.storage.from('ai-images').getPublicUrl(tempName);
                            refImageUrls.push(publicUrl);
                        } catch (e) { throw e; }
                    }));
                }

                // --- æ­¥éª¤ 2: çº¿æ€§æ‹¼æ¥ ---
                preview.innerHTML = '<span class="animate-pulse text-red-600">æ­£åœ¨æ’é˜Ÿç”Ÿæˆ...</span>';
                
                if (currentStylePrompt) finalPrompt += `, ${currentStylePrompt}`;
                if (selectedQuality === '2k') finalPrompt += ", 2k resolution, high detailed";
                if (selectedQuality === '4k') finalPrompt += ", 4k resolution, hyper detailed";

                if (refImageUrls.length > 0) {
                      finalPrompt += ` --sref ${refImageUrls.join(" ")} --iw 2`;
                      refImageUrls.forEach(url => { finalPrompt += ` (Reference Image: ${url})`; });
                }

                // --- æ­¥éª¤ 3: æš´åŠ›å‚æ•°æ³¨å…¥ ---
                const payload = { 
                    model: painterModelId, 
                    prompt: finalPrompt, 
                    size: sizeParam, 
                    n: 1,
                    response_format: "b64_json",  // ç›´æ¥ç´¢è¦ Base64 æ•°æ®ï¼Œä¸èµ° URL ä¸‹è½½
                    image_url: refImageUrls.length > 0 ? refImageUrls[0] : undefined,
                    image: refImageUrls.length > 0 ? refImageUrls[0] : undefined,
                    ref_image_url: refImageUrls.length > 0 ? refImageUrls[0] : undefined
                };

                const res = await fetch('/api/proxy', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload), signal: signal 
                });

                const json = await res.json();
                if (res.status === 402) throw new Error("ä½™é¢ä¸è¶³ (åç«¯æ‹¦æˆª)");
                
                // ğŸŸ¢ ä¿®æ­£ï¼šä¼˜é›…å¤„ç†åç«¯ä¼ å›çš„ 502/å…¶ä»–é”™è¯¯
                if (res.status !== 200) {
                    throw new Error(json.error?.message || json.error || "ç”Ÿæˆå¤±è´¥");
                }

                // --- æ­¥éª¤ 4: ä¿å­˜ç»“æœ ---
                preview.innerHTML = '<span class="text-green-600">ä¿å­˜ä¸­...</span>';
                
                let imgBlob;
                if (json.data[0].b64_json) {
                    imgBlob = base64ToBlob(json.data[0].b64_json, 'image/png');
                } else {
                    const r = await fetch(json.data[0].url); imgBlob = await r.blob();
                }

                const path = `${session.user.id}/${Date.now()}.png`;
                await db.storage.from('ai-images').upload(path, imgBlob, { contentType: 'image/png' });
                const {data:{publicUrl}} = db.storage.from('ai-images').getPublicUrl(path);
                await db.from('images').insert({ user_id: session.user.id, prompt: finalPrompt, image_url: publicUrl, file_path: path });
                
                // ğŸŸ¢ ä¿®æ­£ï¼šç”ŸæˆæˆåŠŸåï¼Œæ˜¾ç¤ºå¸¦ä¸‹è½½æŒ‰é’®çš„é¢„è§ˆ
                preview.innerHTML = `
                    <div class="relative w-full h-full flex items-center justify-center group">
                        <img src="${publicUrl}" class="max-w-full max-h-[75vh] object-contain rounded-lg shadow-2xl">
                        
                        <div class="absolute bottom-6 flex gap-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300 transform translate-y-2 group-hover:translate-y-0">
                            <button onclick="forceDownload('${publicUrl}')" class="bg-white text-slate-900 px-6 py-3 rounded-full font-bold shadow-xl hover:bg-red-50 hover:text-red-600 transition flex items-center gap-2">
                                <span>â¬‡ï¸</span> ä¸‹è½½åŸå›¾
                            </button>
                            <a href="${publicUrl}" target="_blank" class="bg-slate-800/80 backdrop-blur text-white px-4 py-3 rounded-full hover:bg-slate-900 transition" title="æ–°çª—å£æ‰“å¼€">
                                ğŸ”
                            </a>
                        </div>
                    </div>
                `;
                
                if (tempUploadPaths.length > 0) await db.storage.from('ai-images').remove(tempUploadPaths);
                fetchCredits(); loadGallery(); resetUI_Success();

            } catch (e) {
                if(e.name!=='AbortError') {
                    alert(`å‘ç”Ÿé”™è¯¯: ${e.message}`);
                    preview.innerHTML = `<span class="text-red-500 text-xs text-center block p-4">âŒ ${e.message}</span>`;
                } else {
                    preview.innerHTML = '<span class="text-gray-400">ğŸš« å·²ä¸­æ­¢</span>';
                }
                resetUI_Success();
            }
        }

        function resetUI_Success() {
            const btn = document.getElementById('btn-gen');
            abortController = null;
            btn.onclick = generate;
            btn.classList.remove('bg-gray-400', 'hover:bg-gray-500', 'text-white');
            btn.classList.add('btn-primary');
            btn.innerText = `ğŸš€ ç«‹å³ç”Ÿæˆ (æ¶ˆè€— ${currentCost} ç§¯åˆ†)`;
        }

        // --- 6.9 è¾…åŠ©å·¥å…·å‡½æ•° ---
        
        // ğŸŸ¢ æ–°å¢ï¼šå¼ºåˆ¶ä¸‹è½½å›¾ç‰‡å‡½æ•°
        async function forceDownload(url) {
            try {
                const res = await fetch(url);
                const blob = await res.blob();
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = `Z-Design-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch(e) { window.open(url, '_blank'); }
        }

        function base64ToBlob(base64, mimeType) {
            const cleanBase64 = base64.replace(/^data:image\/\w+;base64,/, '').replace(/\s/g, '');
            const byteCharacters = atob(cleanBase64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) { 
                byteNumbers[i] = byteCharacters.charCodeAt(i); 
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // --- 6.10 æ‚é¡¹ & ä¿®å¤ä¸‹è½½/ç”»å»Š (V6.5 ä¿®å¤ç‰ˆ) ---
        function handleCardClick(id,url,path) { 
            if (isSelectMode) { 
                if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); 
                const card = document.getElementById(`card-${id}`), circle = card.querySelector('.check-circle'); 
                if (selectedIds.has(id)) { card.classList.add('selected-card'); circle.innerText = 'âœ“'; } 
                else { card.classList.remove('selected-card'); circle.innerText = ''; } 
                document.getElementById('select-count').innerText = selectedIds.size;
            } else { 
                openLightbox(url, id, path); 
            } 
        }

        function toggleSelectMode() { 
            isSelectMode = !isSelectMode; 
            const btn = document.getElementById('btn-batch-toggle'), bar = document.getElementById('batch-bar'); 
            if (isSelectMode) { 
                btn.classList.replace('bg-gray-100', 'bg-red-50'); btn.classList.replace('text-gray-600', 'text-red-600'); 
                bar.classList.remove('hidden', 'translate-y-20'); 
            } else { 
                btn.classList.replace('bg-red-50', 'bg-gray-100'); btn.classList.replace('text-red-600', 'text-gray-600'); 
                bar.classList.add('translate-y-20'); selectedIds.clear(); 
                loadGallery(); 
            } 
        }

        async function deleteBatch() { 
            if (selectedIds.size === 0) return; 
            if (!confirm(`ç¡®å®šåˆ é™¤ ${selectedIds.size} å¼ å›¾ç‰‡ï¼Ÿ`)) return; 
            const idsArray = Array.from(selectedIds); 
            const { data: files } = await db.from('images').select('file_path').in('id', idsArray); 
            const paths = files.map(f => f.file_path).filter(p => p); 
            if(paths.length) await db.storage.from('ai-images').remove(paths); 
            await db.from('images').delete().in('id', idsArray); 
            toggleSelectMode(); 
        }

        async function deleteSingle(id, filePath, url) { 
            if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return; 
            const el = document.getElementById(`card-${id}`); if (el) el.style.opacity = '0.3'; 
            try { 
                if (filePath) await db.storage.from('ai-images').remove([filePath]); 
                const { error } = await db.from('images').delete().eq('id', id); 
                if(error) throw error; if(el) el.remove(); 
            } catch(e) { alert("åˆ é™¤å¤±è´¥"); if(el) el.style.opacity='1'; } 
        }

        function openLightbox(url, id, filePath) { 
            currentLightboxId = id; currentLightboxUrl = url; currentLightboxPath = filePath;
            document.getElementById('lightbox-img').src = url; 
            document.getElementById('lightbox-download').onclick = () => downloadImage(url);
            document.getElementById('lightbox').classList.remove('hidden'); 
            document.getElementById('lightbox-del-btn').onclick = async () => { 
                if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { 
                    try { if(filePath) await db.storage.from('ai-images').remove([filePath]); await db.from('images').delete().eq('id', id); closeLightbox(); loadGallery(); } 
                    catch(e) { alert(e.message); } 
                } 
            };
        }
        function closeLightbox() { document.getElementById('lightbox').classList.add('hidden'); }
        
        async function downloadImage(url) { 
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); 
                a.href = blobUrl; 
                a.download = `z_ai_${Date.now()}.png`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (e) {
                console.warn("Blob download failed, trying direct link", e);
                window.open(url, '_blank');
            }
        }
        
        function switchTab(t) { ['create','gallery','profile'].forEach(v=>{document.getElementById('view-'+v).classList.add('hidden');document.getElementById('tab-'+v).classList.remove('text-red-600','bg-red-50','border-r-2','border-red-600')}); document.getElementById('view-'+t).classList.remove('hidden');document.getElementById('tab-'+t).classList.add('text-red-600','bg-red-50','border-r-2','border-red-600'); if(t==='gallery') loadGallery(true); }

        // --- 6.11 æ„è§åé¦ˆé€»è¾‘ ---
        async function submitFeedback() {
            const btn = document.getElementById('btn-submit-feedback');
            const contentInput = document.getElementById('feedback-content');
            const contactInput = document.getElementById('feedback-contact');
            
            const content = contentInput.value.trim();
            const contact = contactInput.value.trim();

            if (!content) {
                alert("è¯·å…ˆå†™ç‚¹å†…å®¹å†æäº¤å“¦");
                return;
            }

            const originalText = btn.innerHTML;
            btn.innerHTML = "ğŸ”„ æäº¤ä¸­...";
            btn.disabled = true;

            try {
                const { data: { user } } = await db.auth.getUser();

                const { error } = await db
                    .from('feedback')
                    .insert({
                        content: content,
                        contact: contact,
                        user_id: user ? user.id : null 
                    });

                if (error) throw error;

                alert("âœ… åé¦ˆæäº¤æˆåŠŸï¼Œæ„Ÿè°¢ä½ çš„å»ºè®®ï¼");
                contentInput.value = '';
                contactInput.value = '';

            } catch (err) {
                console.error('Feedback Error:', err);
                alert("æäº¤å¤±è´¥ï¼š" + (err.message || "æœªçŸ¥é”™è¯¯"));
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>

